<!-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Firebase (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
  // ðŸ”¥ Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ”Ð˜Ð firebaseConfig â€” Ð²Ð°Ñˆ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹
  const firebaseConfig = {
    apiKey: "AIzaSyBb0uemCwfr3LpSjqCfbrPzgXMxqJo8ub0",
    authDomain: "rocketteam-counter.firebaseapp.com",
    databaseURL: "https://rocketteam-counter-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "rocketteam-counter",
    storageBucket: "rocketteam-counter.firebasestorage.app",
    messagingSenderId: "882235505564",
    appId: "1:882235505564:web:01dbef24064b0fed5a2659",
    measurementId: "G-RN86EZF81C"
  };

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ (compat-Ñ€ÐµÐ¶Ð¸Ð¼ â€” firebase ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¼)
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const countersRef = database.ref('counters');
  const historyRef = database.ref('history');

  // DOM
  document.getElementById('mainTitle').textContent = 'ÐœÑ‹ Ñ‚ÑƒÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼';
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ru-RU', {
    day: 'numeric', month: 'long', year: 'numeric'
  });

  let data = [];

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
  countersRef.on('value', (snapshot) => {
    const val = snapshot.val();
    if (val) {
      // Firebase Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹, Ð³Ð´Ðµ ÐºÐ»ÑŽÑ‡Ð¸ â€” ÑÑ‚Ð¾ id, Ð° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ â€” Ð´Ð°Ð½Ð½Ñ‹Ðµ
      data = Object.keys(val).map(key => ({
        ...val[key],
        id: key
      }));
      renderCounters();
    } else {
      // Ð•ÑÐ»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½ÐµÑ‚ â€” Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼
      initializeDefaultData();
    }
  });

  function getDefaultData() {
    return [
      { name: "Ð‘Ð¾Ñ‡ÐºÐ°Ñ€ÐµÐ²", type: "Ð—Ð°ÑÐ²ÐºÐ¸", count: 3 },
      { name: "Ð“ÐµÑ€Ñ†", type: "Ð—Ð°ÑÐ²ÐºÐ¸", count: 3 },
      { name: "Ð¡Ð¾Ð³Ð°ÐµÐ²Ð°", type: "Ð—Ð°ÑÐ²ÐºÐ¸", count: 3 },
      { name: "Ð‘Ð¾Ñ‡ÐºÐ°Ñ€ÐµÐ²", type: "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸", count: 2 },
      { name: "Ð“ÐµÑ€Ñ†", type: "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸", count: 2 },
      { name: "Ð¡Ð¾Ð³Ð°ÐµÐ²Ð°", type: "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸", count: 2 }
    ];
  }

  function initializeDefaultData() {
    const defaultData = getDefaultData();
    const updates = {};
    defaultData.forEach(item => {
      const key = getKeyByNameType(item.name, item.type);
      updates[key] = item;
    });
    countersRef.set(updates);
  }

  function getKeyByNameType(name, type) {
    return name + '_' + type.replace(/\s+/g, '_');
  }

  function getStep(type) {
    return type === "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸" ? 2 : 1;
  }

  function changeCount(name, type, sign) {
    const item = data.find(i => i.name === name && i.type === type);
    if (!item) return;

    const step = getStep(type);
    const delta = sign * step;
    const newCount = Math.max(0, item.count + delta);

    const key = getKeyByNameType(name, type);
    countersRef.child(key + '/count').set(newCount);

    historyRef.push({
      time: new Date().toLocaleString('ru-RU'),
      type,
      name,
      delta
    });
  }

  function resetAll() {
    if (!confirm("ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÑ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸?")) return;

    const updates = {};
    let totalClaims = 0, totalBlocks = 0;

    data.forEach(item => {
      const key = getKeyByNameType(item.name, item.type);
      updates[key + '/count'] = 0;
      if (item.type === "Ð—Ð°ÑÐ²ÐºÐ¸") totalClaims += item.count;
      if (item.type === "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸") totalBlocks += item.count;
    });

    countersRef.update(updates);

    historyRef.push({
      time: new Date().toLocaleString('ru-RU'),
      type: "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°",
      name: "",
      delta: 0,
      description: `ÐžÐ±Ð½ÑƒÐ»ÐµÐ½Ð¸Ðµ: Ð·Ð°ÑÐ²ÐºÐ¸ -${totalClaims}, Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ -${totalBlocks}`
    });
  }

  function renderCounters() {
    const claims = data.filter(i => i.type === "Ð—Ð°ÑÐ²ÐºÐ¸");
    const blocks = data.filter(i => i.type === "Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸");

    const renderList = (items, containerId) => {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="btn minus" onclick="changeCount('${item.name}', '${item.type}', -1)">â€“</div>
          <div class="title"><strong>${item.type} ${item.name}</strong><br><span class="count">${item.count}</span></div>
          <div class="btn plus" onclick="changeCount('${item.name}', '${item.type}', 1)">+</div>
        `;
        container.appendChild(div);
      });
    };

    renderList(claims, 'listClaims');
    renderList(blocks, 'listBlocks');
  }
</script>
